<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don Onofre - Mercado & Delicatessen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-store"></i>
                </div>
                <h1 class="title">Mercado Don Onofre</h1>
            </div>
            <p class="subtitle">Delicatessen, productos gourmet y alimentos</p>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                    <i class="fas fa-truck"></i> Env√≠o gratis desde ‚Ç≤ 100.000
                </span>
                <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                    <i class="fas fa-leaf"></i> Productos org√°nicos
                </span>
                <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                    <i class="fas fa-shield-alt"></i> Pago seguro con AdamsPay
                </span>
            </div>
        </header>

        <!-- Navigation -->
        <div class="categories">
            <button class="category-btn active" onclick="filterProducts('all')">
                <i class="fas fa-store"></i> Todos los productos
            </button>
            <button class="category-btn" onclick="filterProducts('gourmet')">
                <i class="fas fa-utensils"></i> Gourmet
            </button>
            <button class="category-btn" onclick="filterProducts('organic')">
                <i class="fas fa-leaf"></i> Org√°nicos
            </button>
            <button class="category-btn" onclick="filterProducts('drinks')">
                <i class="fas fa-wine-bottle"></i> Bebidas
            </button>
            <button class="category-btn" onclick="filterProducts('bakery')">
                <i class="fas fa-bread-slice"></i> Panader√≠a
            </button>
            <button class="category-btn" id="orders-history-btn" onclick="toggleOrdersHistory()">
                <i class="fas fa-history"></i> Mis Pedidos
            </button>
        </div>

        <!-- Products Section -->
        <section class="products">
            <h2 class="section-title">Nuestros Productos Destacados</h2>
            <div class="products-grid" id="products-container">
                <!-- Product 1: Jam√≥n Ib√©rico -->
                <div class="product-card" data-category="gourmet">
                    <div class="product-badge">GOURMET</div>
                    <div class="product-image">
                        <i class="fas fa-drumstick-bite"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Jam√≥n Ib√©rico de Bellota</h3>
                        <p class="product-description">Jam√≥n 100% ib√©rico de bellota, curaci√≥n 36 meses. Producto premium importado de Espa√±a.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Peso: 7-8 kg</div>
                            <div class="feature"><i class="fas fa-clock"></i> Curaci√≥n: 36 meses</div>
                            <div class="feature"><i class="fas fa-tag"></i> Denominaci√≥n de Origen</div>
                            <div class="feature"><i class="fas fa-shipping-fast"></i> Env√≠o refrigerado</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 153.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Jam√≥n Ib√©rico de Bellota', 153000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 2: Queso Artesanal -->
                <div class="product-card" data-category="gourmet organic">
                    <div class="product-badge organic">ORG√ÅNICO</div>
                    <div class="product-image">
                        <i class="fas fa-cheese"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Queso Brie Artesanal</h3>
                        <p class="product-description">Queso brie elaborado con leche cruda de vaca, maduraci√≥n en bodega natural.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Rueda de 2.5 kg</div>
                            <div class="feature"><i class="fas fa-clock"></i> Maduraci√≥n: 60 d√≠as</div>
                            <div class="feature"><i class="fas fa-leaf"></i> Leche org√°nica certificada</div>
                            <div class="feature"><i class="fas fa-home"></i> Elaboraci√≥n artesanal</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 150.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Queso Brie Artesanal', 150000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 3: Vino Premium -->
                <div class="product-card" data-category="drinks gourmet">
                    <div class="product-badge">PREMIUM</div>
                    <div class="product-image">
                        <i class="fas fa-wine-glass-alt"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Vino Malbec Reserva</h3>
                        <p class="product-description">Vino tinto reserva 2018 de Mendoza, Argentina. Crianza 12 meses en roble franc√©s.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-wine-bottle"></i> Botella 750ml</div>
                            <div class="feature"><i class="fas fa-calendar-alt"></i> Cosecha 2018</div>
                            <div class="feature"><i class="fas fa-award"></i> 92 puntos Parker</div>
                            <div class="feature"><i class="fas fa-box"></i> Caja de regalo incluida</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 185.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Vino Malbec Reserva', 185000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 4: Aceite de Oliva -->
                <div class="product-card" data-category="gourmet organic">
                    <div class="product-badge organic">ORG√ÅNICO</div>
                    <div class="product-image">
                        <i class="fas fa-oil-can"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Aceite de Oliva Extra Virgen</h3>
                        <p class="product-description">Aceite premium primera prensada en fr√≠o, variedad arbequina. Producto org√°nico certificado.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Botella 1 litro</div>
                            <div class="feature"><i class="fas fa-snowflake"></i> Primera prensada en fr√≠o</div>
                            <div class="feature"><i class="fas fa-leaf"></i> Certificado org√°nico</div>
                            <div class="feature"><i class="fas fa-globe-europe"></i> Importado de Espa√±a</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 95.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Aceite de Oliva Extra Virgen', 95000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 5: Pan Artesanal -->
                <div class="product-card" data-category="bakery">
                    <div class="product-badge">RECI√âN HORNEADO</div>
                    <div class="product-image">
                        <i class="fas fa-bread-slice"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Pan de Masa Madre</h3>
                        <p class="product-description">Pan artesanal de fermentaci√≥n lenta (72 horas), harina org√°nica y sin conservantes.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Pieza de 800g</div>
                            <div class="feature"><i class="fas fa-clock"></i> Fermentaci√≥n: 72h</div>
                            <div class="feature"><i class="fas fa-wheat"></i> Harina org√°nica integral</div>
                            <div class="feature"><i class="fas fa-fire"></i> Horneado en piedra</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 35.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Pan de Masa Madre', 35000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 6: Caf√© Especial -->
                <div class="product-card" data-category="drinks gourmet">
                    <div class="product-badge new">NUEVO</div>
                    <div class="product-image">
                        <i class="fas fa-coffee"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Caf√© Especial Geisha</h3>
                        <p class="product-description">Caf√© de especialidad variedad Geisha, tostado medio, notas frutales y florales.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Bolsa 500g</div>
                            <div class="feature"><i class="fas fa-mountain"></i> Altura: 1800msnm</div>
                            <div class="feature"><i class="fas fa-seedling"></i> Cultivo sostenible</div>
                            <div class="feature"><i class="fas fa-trophy"></i> Premio de calidad</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 120.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Caf√© Especial Geisha', 120000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 7: Miel Org√°nica -->
                <div class="product-card" data-category="organic">
                    <div class="product-badge organic">100% NATURAL</div>
                    <div class="product-image">
                        <i class="fas fa-honey-pot"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Miel Org√°nica Multifloral</h3>
                        <p class="product-description">Miel pura de abejas sin procesar, cosechada en colmenares org√°nicos certificados.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-weight"></i> Frasco 1kg</div>
                            <div class="feature"><i class="fas fa-bee"></i> Apicultura org√°nica</div>
                            <div class="feature"><i class="fas fa-filter"></i> Sin pasteurizar</div>
                            <div class="feature"><i class="fas fa-certificate"></i> Certificado ecol√≥gico</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 65.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Miel Org√°nica Multifloral', 65000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product 8: Cesta Regalo -->
                <div class="product-card" data-category="gourmet">
                    <div class="product-badge limited">EDICI√ìN LIMITADA</div>
                    <div class="product-image">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="product-content">
                        <h3 class="product-name">Cesta Gourmet Navide√±a</h3>
                        <p class="product-description">Selecci√≥n premium: jam√≥n, queso, vino, aceite y dulces. Ideal para regalo empresarial.</p>
                        
                        <div class="product-features">
                            <div class="feature"><i class="fas fa-box"></i> 8 productos premium</div>
                            <div class="feature"><i class="fas fa-gift"></i> Empaque de regalo</div>
                            <div class="feature"><i class="fas fa-shipping-fast"></i> Env√≠o gratis</div>
                            <div class="feature"><i class="fas fa-edit"></i> Tarjeta personalizada</div>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price">‚Ç≤ 550.000</div>
                            <button class="buy-btn" onclick="comprarProducto('Cesta Gourmet Navide√±a', 550000)">
                                <i class="fas fa-shopping-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Order Result Section -->
        <section class="order-result" id="order-result">
            <div class="order-header">
                <div class="order-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <h2 class="order-title">Detalles de tu Pedido</h2>
            </div>
            
            <div class="order-status" id="order-status">
                <div class="status-text" id="status-text">Procesando tu pedido...</div>
                <div class="order-id" id="order-id"></div>
            </div>
            
            <div class="order-actions" id="order-actions">
                <!-- Actions will be added dynamically -->
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--primary);">
                    <i class="fas fa-info-circle"></i> Informaci√≥n importante para tu compra
                </h3>
                <p style="font-size: 0.9rem; color: var(--gray);">
                    <i class="fas fa-shipping-fast" style="color: var(--secondary);"></i> Env√≠o gratis en Asunci√≥n para pedidos mayores a ‚Ç≤ 100.000<br>
                    <i class="fas fa-clock" style="color: var(--accent);"></i> Productos perecederos: entrega en 24-48 horas<br>
                    <i class="fas fa-undo" style="color: var(--success);"></i> 15 d√≠as para devoluciones de productos no perecederos<br>
                    <i class="fas fa-phone" style="color: var(--primary);"></i> Atenci√≥n al cliente: (021) 123-456
                </p>
            </div>
        </section>

        <!-- Order History Section -->
        <section class="order-history" id="order-history" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-history"></i> Historial de Pedidos
            </h2>
            
            <div class="order-filters" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="category-btn" onclick="filterOrders('all')">
                    <i class="fas fa-list"></i> Todos
                </button>
                <button class="category-btn" onclick="filterOrders('PENDING')">
                    <i class="fas fa-clock"></i> Pendientes
                </button>
                <button class="category-btn" onclick="filterOrders('PAID')">
                    <i class="fas fa-check-circle"></i> Pagados
                </button>
                <button class="category-btn" onclick="filterOrders('FAILED')">
                    <i class="fas fa-times-circle"></i> Fallidos
                </button>
            </div>
            
            <div class="orders-table-container" style="background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: var(--primary); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-hashtag"></i> ID</th>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-box"></i> Producto</th>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-money-bill-wave"></i> Monto</th>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-info-circle"></i> Estado</th>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-calendar"></i> Fecha</th>
                            <th style="padding: 15px; text-align: left;"><i class="fas fa-cog"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Los pedidos se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
                
                <div id="orders-empty" style="padding: 40px; text-align: center; color: var(--gray); display: none;">
                    <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3 style="color: var(--dark); margin-bottom: 10px;">No hay pedidos a√∫n</h3>
                    <p>Realiza tu primera compra para ver tu historial aqu√≠.</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <h3 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-store"></i> Mercado Don Onofre
            </h3>
            <p>Delicatessen y productos gourmet</p>
            
            <div class="store-info">
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Av. Espa√±a 1234, Asunci√≥n</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <span>(021) 123-456</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span>Lun-S√°b: 8:00-20:00</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-envelope"></i>
                    <span>info@dononofre.com.py</span>
                </div>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.8rem; color: var(--gray);">
                <strong>Prueba T√©cnica Senior:</strong> Sistema de e-commerce integrado con AdamsPay para procesamiento de pagos seguros.
            </p>
        </footer>

        <!-- Cart Summary (fixed) -->
        <div class="cart-summary" id="cart-summary" style="display: none;">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-count">0</span> productos
        </div>
    </div>

    <script>
        // Estado global
        let currentOrderId = null;
        let cartItems = [];
        let ordersHistory = [];
        
        // Funci√≥n para formatear precios al estilo paraguayo (punto como separador decimal)
        function formatPricePY(price) {
            // Si el precio ya es un string con formato, extraer el n√∫mero
            if (typeof price === 'string') {
                // Extraer solo los n√∫meros (eliminar s√≠mbolos y letras)
                const numStr = price.replace(/[^\d.]/g, '');
                price = parseFloat(numStr);
            }
            
            // Convertir a n√∫mero si es string
            const numValue = typeof price === 'number' ? price : parseFloat(price);
            
            // Asegurar que tenga 3 decimales
            const withThreeDecimals = numValue.toFixed(3);
            
            // Separar parte entera y decimal
            const [integerPart, decimalPart] = withThreeDecimals.split('.');
            
            // Formatear parte entera con puntos de miles
            let formattedInteger = '';
            const integerStr = integerPart.toString();
            const len = integerStr.length;
            
            for (let i = 0; i < len; i++) {
                const digit = integerStr[len - 1 - i];
                formattedInteger = digit + formattedInteger;
                if ((i + 1) % 3 === 0 && i !== len - 1) {
                    formattedInteger = '.' + formattedInteger;
                }
            }
            
            return `${formattedInteger}.${decimalPart}`;
        }
        
        // Funci√≥n para filtrar productos
        function filterProducts(category) {
            const products = document.querySelectorAll('.product-card');
            const buttons = document.querySelectorAll('.category-btn:not(#orders-history-btn)');
            
            // Actualizar botones activos
            buttons.forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase();
                if (category === 'all' && btnText.includes('todos')) {
                    btn.classList.add('active');
                } else if (btnText.includes(category)) {
                    btn.classList.add('active');
                }
            });
            
            // Ocultar secci√≥n de historial si est√° visible
            const orderHistorySection = document.getElementById('order-history');
            const ordersBtn = document.getElementById('orders-history-btn');
            if (orderHistorySection.style.display === 'block') {
                orderHistorySection.style.display = 'none';
                ordersBtn.classList.remove('active');
            }
            
            // Mostrar productos
            document.querySelector('.products').style.display = 'block';
            
            // Mostrar/ocultar productos
            products.forEach(product => {
                const productCategories = product.dataset.category.split(' ');
                
                if (category === 'all' || productCategories.includes(category)) {
                    product.style.display = 'block';
                    setTimeout(() => {
                        product.style.opacity = '1';
                        product.style.transform = 'translateY(0)';
                    }, 100);
                } else {
                    product.style.opacity = '0';
                    product.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        product.style.display = 'none';
                    }, 300);
                }
            });
        }
        
        // Funci√≥n para alternar entre productos e historial
        function toggleOrdersHistory() {
            const productsSection = document.querySelector('.products');
            const orderHistorySection = document.getElementById('order-history');
            const ordersBtn = document.getElementById('orders-history-btn');
            const categoryBtns = document.querySelectorAll('.category-btn:not(#orders-history-btn)');
            
            if (orderHistorySection.style.display === 'none' || !orderHistorySection.style.display) {
                // Mostrar historial
                productsSection.style.display = 'none';
                orderHistorySection.style.display = 'block';
                ordersBtn.classList.add('active');
                categoryBtns.forEach(btn => btn.classList.remove('active'));
                
                // Cargar pedidos
                loadOrdersHistory();
            } else {
                // Mostrar productos
                productsSection.style.display = 'block';
                orderHistorySection.style.display = 'none';
                ordersBtn.classList.remove('active');
                filterProducts('all');
            }
        }
        
        // Funci√≥n para cargar el historial de pedidos
        function loadOrdersHistory() {
            const ordersTableBody = document.getElementById('orders-table-body');
            const ordersEmpty = document.getElementById('orders-empty');
            
            // Cargar historial desde localStorage
            loadOrdersFromLocalStorage();
            
            // Limpiar tabla
            ordersTableBody.innerHTML = '';
            
            if (ordersHistory.length === 0) {
                ordersEmpty.style.display = 'block';
                return;
            }
            
            ordersEmpty.style.display = 'none';
            
            // Ordenar por fecha (m√°s reciente primero)
            const sortedOrders = [...ordersHistory].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            // Agregar filas a la tabla
            sortedOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'order-row';
                row.dataset.status = order.status;
                
                // Formatear fecha
                const fecha = new Date(order.created_at);
                const fechaFormateada = fecha.toLocaleDateString('es-PY', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Determinar clase de estado
                let statusClass = 'status-pending';
                let statusText = 'Pendiente';
                
                if (order.status === 'PAID') {
                    statusClass = 'status-paid';
                    statusText = 'Pagado';
                } else if (order.status === 'FAILED') {
                    statusClass = 'status-failed';
                    statusText = 'Fallido';
                }
                
                // Formatear precio
                const precioFormateado = formatPricePY(order.amount);
                
                // Crear botones de acci√≥n
                let actionButtons = '';
                
                if (order.status === 'PENDING') {
                    actionButtons = `
                        <button class="action-btn view-btn" onclick="viewOrderDetail('${order.id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${order.payment_link ? `
                        <button class="action-btn pay-btn" onclick="window.open('${order.payment_link}', '_blank')">
                            <i class="fas fa-external-link-alt"></i> Pagar
                        </button>
                        ` : ''}
                    `;
                } else if (order.status === 'FAILED') {
                    actionButtons = `
                        <button class="action-btn view-btn" onclick="viewOrderDetail('${order.id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="action-btn retry-btn" onclick="retryOrder('${order.id}')">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="action-btn view-btn" onclick="viewOrderDetail('${order.id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                }
                
                row.innerHTML = `
                    <td>
                        <span style="font-family: monospace; font-size: 0.85rem; color: var(--dark);">
                            ${order.id.substring(0, 8)}...
                        </span>
                    </td>
                    <td>
                        <strong style="color: var(--primary);">${order.product_name}</strong>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: var(--dark);">‚Ç≤ ${precioFormateado}</span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <span style="font-size: 0.9rem; color: var(--gray);">${fechaFormateada}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                ordersTableBody.appendChild(row);
            });
        }
        
        // Funci√≥n para filtrar pedidos por estado
        function filterOrders(status) {
            const rows = document.querySelectorAll('.order-row');
            const filterBtns = document.querySelectorAll('.order-filters .category-btn');
            
            // Actualizar botones activos
            filterBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            rows.forEach(row => {
                if (status === 'all' || row.dataset.status === status) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Funci√≥n para ver detalles de un pedido
        function viewOrderDetail(orderId) {
            const order = ordersHistory.find(o => o.id === orderId);
            if (!order) return;
            
            // Formatear fecha
            const fecha = new Date(order.created_at);
            const fechaFormateada = fecha.toLocaleDateString('es-PY', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Formatear precio
            const precioFormateado = formatPricePY(order.amount);
            
            // Determinar estado
            let estadoTexto = 'Pendiente';
            if (order.status === 'PAID') estadoTexto = 'Pagado';
            if (order.status === 'FAILED') estadoTexto = 'Fallido';
            
            // Mostrar detalles en el modal/alerta
            const detalles = `
            **Mercado Don Onofre**\n\n
            **DETALLES DEL PEDIDO**\n
            ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n
            **ID:** ${order.id}\n
            **Producto:** ${order.product_name}\n
            **Monto:** ‚Ç≤ ${precioFormateado}\n
            **Estado:** ${estadoTexto}\n
            **Fecha:** ${fechaFormateada}\n
            **Enlace de pago:** ${order.payment_link || 'No disponible'}\n\n
            ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n
            **Acciones disponibles:**\n
            ‚Ä¢ Verificar estado actual\n
            ${order.status === 'PENDING' && order.payment_link ? '‚Ä¢ Completar el pago\n' : ''}
            ${order.status === 'FAILED' ? '‚Ä¢ Reintentar compra\n' : ''}
            \nüìû **Soporte:** (021) 123-456
            `;
            
            alert(detalles);
        }
        
        // Funci√≥n para reintentar un pedido fallido
        function retryOrder(orderId) {
            const order = ordersHistory.find(o => o.id === orderId);
            if (!order) return;
            
            if (confirm(`¬øDeseas reintentar la compra de "${order.product_name}" por ‚Ç≤ ${formatPricePY(order.amount)}?`)) {
                // Volver a la secci√≥n de productos
                toggleOrdersHistory();
                // Simular clic en el producto correspondiente (esto es simplificado)
                // En una implementaci√≥n real, deber√≠as buscar y hacer scroll al producto
                setTimeout(() => {
                    comprarProducto(order.product_name, order.amount);
                }, 500);
            }
        }
        
        function comprarProducto(nombreProducto, monto) {
            const orderResult = document.getElementById('order-result');
            const statusText = document.getElementById('status-text');
            const orderIdElement = document.getElementById('order-id');
            const orderActions = document.getElementById('order-actions');
            
            // Formatear el precio para mostrar
            const precioFormateado = formatPricePY(monto);
            
            // Agregar al carrito
            cartItems.push({
                name: nombreProducto,
                price: monto,
                priceFormatted: `‚Ç≤ ${precioFormateado}`,
                timestamp: new Date().toISOString()
            });
            updateCartSummary();
            
            // Crear pedido temporal para historial
            const tempOrderId = `temp_${Date.now()}`;
            const tempOrder = {
                id: tempOrderId,
                product_name: nombreProducto,
                amount: monto,
                status: 'PENDING',
                payment_link: null,
                created_at: new Date().toISOString()
            };
            
            ordersHistory.push(tempOrder);
            saveOrdersToLocalStorage();
            
            // Mostrar secci√≥n de resultado
            orderResult.style.display = 'block';
            orderResult.scrollIntoView({ behavior: 'smooth' });
            
            // Resetear estado
            statusText.innerHTML = `
                <span style="color: #8B4513;">
                    <i class="fas fa-spinner fa-spin"></i> Preparando tu pedido...
                </span>
            `;
            orderIdElement.textContent = '';
            orderActions.innerHTML = '';
            
            // Deshabilitar botones temporalmente
            document.querySelectorAll('.buy-btn').forEach(btn => {
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Procesando...`;
                btn.dataset.original = originalText;
            });
            
            // Formatear monto para API (centavos)
            const amountInCents = monto;
            
            // Realizar solicitud a la API
            fetch('/api/orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_name: nombreProducto,
                    amount: amountInCents,
                    currency: 'PYG'
                })
            })
            .then(async response => {
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Error HTTP: ${response.status}`);
                }
                
                return data;
            })
            .then(datos => {
                console.log('Respuesta del servidor:', datos);
                currentOrderId = datos.id;
                
                // Actualizar el pedido temporal con datos reales
                const tempIndex = ordersHistory.findIndex(o => o.id === tempOrderId);
                if (tempIndex !== -1) {
                    ordersHistory[tempIndex] = {
                        id: datos.id,
                        product_name: nombreProducto,
                        amount: monto,
                        status: 'PENDING',
                        payment_link: datos.payment_link || null,
                        created_at: new Date().toISOString()
                    };
                    saveOrdersToLocalStorage();
                }
                
                // Actualizar estado
                if (datos.error) {
                    statusText.innerHTML = `
                        <span style="color: #8B0000;">
                            <i class="fas fa-exclamation-circle"></i> Error: ${datos.error}
                        </span>
                    `;
                } else {
                    // Mostrar informaci√≥n del pedido
                    orderIdElement.textContent = `ID del Pedido: ${datos.id}`;
                    
                    if (datos.warning) {
                        statusText.innerHTML = `
                            <span style="color: #D2691E;">
                                <i class="fas fa-exclamation-triangle"></i> Pedido creado con advertencia: ${datos.warning}
                            </span>
                        `;
                    } else {
                        statusText.innerHTML = `
                            <span style="color: #2E8B57;">
                                <i class="fas fa-check-circle"></i> ¬°Pedido creado con √©xito!
                            </span>
                        `;
                    }
                    
                    // Mostrar acciones disponibles
                    orderActions.innerHTML = '';
                    
                    if (datos.payment_link) {
                        const paymentLink = document.createElement('a');
                        paymentLink.href = datos.payment_link;
                        paymentLink.className = 'payment-link';
                        paymentLink.target = '_blank';
                        paymentLink.innerHTML = `
                            <i class="fas fa-external-link-alt"></i>
                            Proceder al Pago con AdamsPay
                        `;
                        orderActions.appendChild(paymentLink);
                        
                        // Bot√≥n para verificar estado
                        const statusBtn = document.createElement('button');
                        statusBtn.className = 'status-btn';
                        statusBtn.innerHTML = `
                            <i class="fas fa-sync-alt"></i>
                            Verificar Estado del Pago
                        `;
                        statusBtn.onclick = () => verificarEstadoPedido(datos.id);
                        orderActions.appendChild(statusBtn);
                        
                        // Bot√≥n para seguir comprando
                        const continueBtn = document.createElement('button');
                        continueBtn.className = 'status-btn';
                        continueBtn.style.background = '#3498db';
                        continueBtn.innerHTML = `
                            <i class="fas fa-shopping-cart"></i>
                            Seguir Comprando
                        `;
                        continueBtn.onclick = () => {
                            orderResult.style.display = 'none';
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        };
                        orderActions.appendChild(continueBtn);
                        
                        // Contador para redirecci√≥n autom√°tica
                        let countdown = 8;
                        const countdownElement = document.createElement('div');
                        countdownElement.style.marginTop = '15px';
                        countdownElement.style.color = 'var(--primary)';
                        countdownElement.style.fontSize = '0.9rem';
                        countdownElement.style.fontWeight = '600';
                        countdownElement.id = 'countdown';
                        orderActions.appendChild(countdownElement);
                        
                        const countdownInterval = setInterval(() => {
                            countdownElement.innerHTML = `
                                <i class="fas fa-clock"></i>
                                Redirigiendo a AdamsPay en ${countdown} segundos...
                            `;
                            countdown--;
                            
                            if (countdown < 0) {
                                clearInterval(countdownInterval);
                                if (datos.payment_link && !datos.payment_link.includes('fallback')) {
                                    window.open(datos.payment_link, '_blank');
                                }
                            }
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.innerHTML = `
                    <span style="color: #8B0000;">
                        <i class="fas fa-times-circle"></i> Error: ${error.message}
                    </span>
                `;
                
                // Actualizar estado del pedido temporal a fallido
                const tempIndex = ordersHistory.findIndex(o => o.id === tempOrderId);
                if (tempIndex !== -1) {
                    ordersHistory[tempIndex].status = 'FAILED';
                    saveOrdersToLocalStorage();
                }
                
                // Mostrar bot√≥n para reintentar
                const retryBtn = document.createElement('button');
                retryBtn.className = 'status-btn';
                retryBtn.innerHTML = `<i class="fas fa-redo"></i> Reintentar Compra`;
                retryBtn.onclick = () => comprarProducto(nombreProducto, monto);
                orderActions.appendChild(retryBtn);
            })
            .finally(() => {
                // Rehabilitar botones
                document.querySelectorAll('.buy-btn').forEach(btn => {
                    if (btn.dataset.original) {
                        btn.disabled = false;
                        btn.innerHTML = btn.dataset.original;
                    }
                });
            });
        }
        
        function verificarEstadoPedido(idPedido) {
            const statusText = document.getElementById('status-text');
            const previousText = statusText.innerHTML;
            
            statusText.innerHTML = `
                <span style="color: #8B4513;">
                    <i class="fas fa-spinner fa-spin"></i> Consultando estado del pago...
                </span>
            `;
            
            fetch(`/api/orders/${idPedido}/`)
                .then(response => response.json())
                .then(datos => {
                    let statusColor, statusIcon, statusMessage, additionalInfo;
                    
                    switch(datos.status) {
                        case 'pending':
                            statusColor = '#8B4513';
                            statusIcon = '<i class="fas fa-clock"></i>';
                            statusMessage = 'Pendiente de pago';
                            additionalInfo = 'Por favor, completa el pago para procesar tu pedido.';
                            break;
                        case 'paid':
                            statusColor = '#2E8B57';
                            statusIcon = '<i class="fas fa-check-circle"></i>';
                            statusMessage = '¬°Pago Confirmado!';
                            additionalInfo = 'Tu pedido est√° siendo preparado para el env√≠o.';
                            break;
                        case 'failed':
                            statusColor = '#8B0000';
                            statusIcon = '<i class="fas fa-times-circle"></i>';
                            statusMessage = 'Pago Fallido';
                            additionalInfo = 'El pago no pudo ser procesado. Intenta nuevamente.';
                            break;
                        default:
                            statusColor = '#8B4513';
                            statusIcon = '<i class="fas fa-info-circle"></i>';
                            statusMessage = datos.status || 'Estado desconocido';
                            additionalInfo = 'Contacta a nuestro servicio al cliente.';
                    }
                    
                    statusText.innerHTML = `
                        <span style="color: ${statusColor}">
                            ${statusIcon} ${statusMessage}
                        </span>
                    `;
                    
                    // Actualizar historial local
                    const orderIndex = ordersHistory.findIndex(o => o.id === idPedido);
                    if (orderIndex !== -1) {
                        ordersHistory[orderIndex].status = datos.status.toUpperCase();
                        saveOrdersToLocalStorage();
                    }
                    
                    // Mostrar alerta detallada
                    setTimeout(() => {
                        // Formatear el precio para la alerta
                        const productPrice = datos.amount ? `‚Ç≤ ${formatPricePY(datos.amount)}` : 'N/A';
                        alert(`**Mercado Don Onofre**\n\n` +
                            `**Pedido #${idPedido}**\n` +
                            `**Producto:** ${datos.product_name || 'N/A'}\n` +
                            `**Total:** ${productPrice}\n` +
                            `**Estado:** ${statusMessage}\n` +
                            `**Fecha:** ${new Date(datos.created_at).toLocaleString('es-PY')}\n\n` +
                            `**Informaci√≥n:** ${additionalInfo}\n\n` +
                            `**Contacto:** (021) 123-456`);
                    }, 300);
                })
                .catch(error => {
                    console.error('Error al verificar estado:', error);
                    statusText.innerHTML = previousText;
                    alert('Error al verificar el estado del pedido. Por favor, intenta nuevamente o contacta a nuestro servicio al cliente.');
                });
        }
        
        function updateCartSummary() {
            const cartSummary = document.getElementById('cart-summary');
            const cartCount = document.getElementById('cart-count');
            
            cartCount.textContent = cartItems.length;
            
            if (cartItems.length > 0) {
                cartSummary.style.display = 'flex';
                
                // Calcular total
                const total = cartItems.reduce((sum, item) => sum + item.price, 0);
                const totalFormatted = formatPricePY(total);
                
                // Mostrar tooltip con resumen
                cartSummary.title = `Productos en carrito:\n${cartItems.map(item => `‚Ä¢ ${item.name} - ‚Ç≤ ${formatPricePY(item.price)}`).join('\n')}\n\n Total: ‚Ç≤ ${totalFormatted}`;
            }
        }
        
        // Guardar historial en localStorage
        function saveOrdersToLocalStorage() {
            localStorage.setItem('donOnofreOrders', JSON.stringify(ordersHistory));
        }
        
        // Cargar historial desde localStorage
        function loadOrdersFromLocalStorage() {
            const savedOrders = localStorage.getItem('donOnofreOrders');
            if (savedOrders) {
                ordersHistory = JSON.parse(savedOrders);
            }
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar historial desde localStorage
            loadOrdersFromLocalStorage();
            
            // Efecto de aparici√≥n suave para las tarjetas
            const cards = document.querySelectorAll('.product-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // Formatear todos los precios en la p√°gina
            document.querySelectorAll('.product-price').forEach(priceElement => {
                const originalHTML = priceElement.innerHTML;
                
                // Buscar patrones de precios (‚Ç≤ seguido de n√∫mero)
                const priceRegex = /‚Ç≤\s*([\d,.]+)/g;
                let nuevoHTML = originalHTML;
                
                let match;
                while ((match = priceRegex.exec(originalHTML)) !== null) {
                    const precioOriginal = match[1];
                    const precioFormateado = formatPricePY(precioOriginal);
                    nuevoHTML = nuevoHTML.replace(precioOriginal, precioFormateado);
                }
                
                priceElement.innerHTML = nuevoHTML;
            });
            
            // Tambi√©n formatear precios tachados (old-price)
            document.querySelectorAll('.old-price').forEach(priceElement => {
                const originalHTML = priceElement.innerHTML;
                
                // Buscar n√∫meros
                const priceRegex = /([\d,.]+)/g;
                let nuevoHTML = originalHTML;
                
                let match;
                while ((match = priceRegex.exec(originalHTML)) !== null) {
                    const precioOriginal = match[1];
                    const precioFormateado = formatPricePY(precioOriginal);
                    nuevoHTML = nuevoHTML.replace(precioOriginal, precioFormateado);
                }
                
                priceElement.innerHTML = nuevoHTML;
            });
            
            // Configurar el carrito
            const cartSummary = document.getElementById('cart-summary');
            cartSummary.addEventListener('click', () => {
                if (cartItems.length > 0) {
                    // Calcular total
                    const total = cartItems.reduce((sum, item) => sum + item.price, 0);
                    const totalFormatted = formatPricePY(total);
                    
                    alert(`üõí **Tu Carrito de Compras**\n\n` +
                        `${cartItems.map((item, index) => `${index + 1}. ${item.name} - ‚Ç≤ ${formatPricePY(item.price)}`).join('\n')}\n\n` +
                        `**Total:** ‚Ç≤ ${totalFormatted}\n\n` +
                        `*Los productos se procesan individualmente para mejor control de inventario.`);
                }
            });
        });
    </script>
</body>
</html>